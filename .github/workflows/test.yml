name: Docker Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check Docker version
        run: docker --version
      
      - name: Build Docker image
        run: docker build -t coc-vue-test .
      
      - name: Create test results directory
        run: mkdir -p test-results
      
      - name: Run tests in Docker
        run: docker run --rm -v $(pwd)/.ci-artifacts:/app/.ci-artifacts coc-vue-test ./scripts/docker-run-tests.sh
      
      - name: Add test summary to GitHub Actions output
        if: always()
        continue-on-error: true
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          
          # Check if Jest test results exist
          if [ -f "test-results/jest-results.json" ]; then
            TOTAL_TESTS=$(jq '.numTotalTests' test-results/jest-results.json)
            PASSED_TESTS=$(jq '.numPassedTests' test-results/jest-results.json)
            FAILED_TESTS=$(jq '.numFailedTests' test-results/jest-results.json)
            
            echo "### Jest Tests" >> $GITHUB_STEP_SUMMARY
            echo "- Total: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED_TESTS" -gt 0 ]; then
              echo "❌ Some Jest tests failed." >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ All Jest tests passed." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Jest Tests" >> $GITHUB_STEP_SUMMARY
            echo "❓ No Jest test results found." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check if Vader test results exist
          if [ -d ".ci-artifacts/vader-reports" ] && [ "$(ls -A .ci-artifacts/vader-reports)" ]; then
            echo "### Vader Tests" >> $GITHUB_STEP_SUMMARY
            
            # Count total tests and successes
            TOTAL_TESTS=0
            PASSED_TESTS=0
            
            for file in .ci-artifacts/vader-reports/*_results.json; do
              if [ -f "$file" ]; then
                # Utiliser grep au lieu de jq pour être plus tolérant aux erreurs de format
                FILE_TOTAL=$(grep -o '"total":[[:space:]]*[0-9]\+' "$file" | grep -o '[0-9]\+')
                FILE_SUCCESS=$(grep -o '"success":[[:space:]]*[0-9]\+' "$file" | grep -o '[0-9]\+')
                
                # Si les valeurs sont vides, essayer avec les anciens noms de champs
                if [ -z "$FILE_TOTAL" ]; then
                  FILE_TOTAL=$(grep -o '"total_count":[[:space:]]*[0-9]\+' "$file" | grep -o '[0-9]\+')
                fi
                if [ -z "$FILE_SUCCESS" ]; then
                  FILE_SUCCESS=$(grep -o '"success_count":[[:space:]]*[0-9]\+' "$file" | grep -o '[0-9]\+')
                fi
                
                # Si toujours vide, utiliser des valeurs par défaut
                FILE_TOTAL=${FILE_TOTAL:-0}
                FILE_SUCCESS=${FILE_SUCCESS:-0}
                
                TOTAL_TESTS=$((TOTAL_TESTS + FILE_TOTAL))
                PASSED_TESTS=$((PASSED_TESTS + FILE_SUCCESS))
                
                TEST_NAME=$(basename "$file" _results.json)
                FILE_FAILED=$((FILE_TOTAL - FILE_SUCCESS))
                
                echo "#### $TEST_NAME" >> $GITHUB_STEP_SUMMARY
                echo "- Total: $FILE_TOTAL" >> $GITHUB_STEP_SUMMARY
                echo "- Passed: $FILE_SUCCESS" >> $GITHUB_STEP_SUMMARY
                echo "- Failed: $FILE_FAILED" >> $GITHUB_STEP_SUMMARY
                
                if [ "$FILE_FAILED" -gt 0 ]; then
                  echo "❌ Some tests failed in $TEST_NAME." >> $GITHUB_STEP_SUMMARY
                else
                  echo "✅ All tests passed in $TEST_NAME." >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
            
            FAILED_TESTS=$((TOTAL_TESTS - PASSED_TESTS))
            
            echo "#### Summary" >> $GITHUB_STEP_SUMMARY
            echo "- Total Vader Tests: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Total Passed: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Total Failed: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED_TESTS" -gt 0 ]; then
              echo "❌ Some Vader tests failed." >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ All Vader tests passed." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Vader Tests" >> $GITHUB_STEP_SUMMARY
            echo "❌ No Vader test results found." >> $GITHUB_STEP_SUMMARY
          fi
      
      # Temporarily disabled artifact upload due to GitHub Actions issues
      # - name: Upload test artifacts
      #   if: always()
      #   uses: actions/upload-artifact@v2
      #   with:
      #     name: test-artifacts
      #     path: |
      #       test-output.log
      #       .ci-artifacts/vader-reports/
      #     retention-days: 7
