name: Docker Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check Docker version
        run: docker --version
      
      - name: Build Docker image
        run: docker build -t coc-vue-test .
      
      - name: Create test results directory
        run: mkdir -p test-results
      
      - name: Run tests in Docker
        run: docker run --rm -v $(pwd)/.ci-artifacts:/app/.ci-artifacts coc-vue-test ./scripts/docker-run-tests.sh
      
      - name: Add test summary to GitHub Actions output
        if: always()
        continue-on-error: true
        run: |
          echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Test execution completed at $(date)" >> $GITHUB_STEP_SUMMARY
          
          # Check if Jest test results exist
          if [ -f "test-results/jest-results.json" ]; then
            TOTAL_TESTS=$(jq '.numTotalTests' test-results/jest-results.json)
            PASSED_TESTS=$(jq '.numPassedTests' test-results/jest-results.json)
            FAILED_TESTS=$(jq '.numFailedTests' test-results/jest-results.json)
            
            echo "### ðŸ§ª Jest Tests" >> $GITHUB_STEP_SUMMARY
            echo "- Total Tests: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED_TESTS" -gt 0 ]; then
              echo "âŒ Failed Tests:" >> $GITHUB_STEP_SUMMARY
              # Get failed test names
              FAILED_TEST_NAMES=$(jq -r '.testResults[] | select(.status == "failed") | .name' test-results/jest-results.json)
              if [ -n "$FAILED_TEST_NAMES" ]; then
                echo "$FAILED_TEST_NAMES" | while read -r test_name; do
                  echo "  - $test_name" >> $GITHUB_STEP_SUMMARY
                done
              fi
              echo "âŒ Some Jest tests failed." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… All Jest tests passed." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ðŸ§ª Jest Tests" >> $GITHUB_STEP_SUMMARY
            echo "â“ No Jest test results found." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check if Vader test results exist
          if [ -d ".ci-artifacts/vader-reports" ] && [ "$(ls -A .ci-artifacts/vader-reports)" ]; then
            echo "### ðŸ§ª Vader Tests" >> $GITHUB_STEP_SUMMARY
            
            # Count total tests and successes
            TOTAL_TESTS=0
            PASSED_TESTS=0
            
            for file in .ci-artifacts/vader-reports/*_results.json; do
              if [ -f "$file" ]; then
                # Use grep instead of jq to be more tolerant of format errors
                FILE_TOTAL=$(grep -o '"total":[[:space:]]*[0-9]\+' "$file" | grep -o '[0-9]\+')
                FILE_SUCCESS=$(grep -o '"success":[[:space:]]*[0-9]\+' "$file" | grep -o '[0-9]\+')
                
                # If values are empty, try with old field names
                if [ -z "$FILE_TOTAL" ]; then
                  FILE_TOTAL=$(grep -o '"total_count":[[:space:]]*[0-9]\+' "$file" | grep -o '[0-9]\+')
                fi
                if [ -z "$FILE_SUCCESS" ]; then
                  FILE_SUCCESS=$(grep -o '"success_count":[[:space:]]*[0-9]\+' "$file" | grep -o '[0-9]\+')
                fi
                
                # If still empty, use default values
                FILE_TOTAL=${FILE_TOTAL:-0}
                FILE_SUCCESS=${FILE_SUCCESS:-0}
                
                TOTAL_TESTS=$((TOTAL_TESTS + FILE_TOTAL))
                PASSED_TESTS=$((PASSED_TESTS + FILE_SUCCESS))
                
                TEST_NAME=$(basename "$file" _results.json)
                FILE_FAILED=$((FILE_TOTAL - FILE_SUCCESS))
                
                echo "#### $TEST_NAME" >> $GITHUB_STEP_SUMMARY
                echo "- Total: $FILE_TOTAL" >> $GITHUB_STEP_SUMMARY
                echo "- Passed: $FILE_SUCCESS" >> $GITHUB_STEP_SUMMARY
                echo "- Failed: $FILE_FAILED" >> $GITHUB_STEP_SUMMARY
                
                if [ "$FILE_FAILED" -gt 0 ]; then
                  # Get failed test names from the report
                  FAILED_TEST_NAMES=$(grep -o '"name":"[^"]*","status":"failed"' "$file" | grep -o '"name":"[^"]*"' | sed 's/"name"://g' | sed 's/"//g')
                  if [ -n "$FAILED_TEST_NAMES" ]; then
                    echo "âŒ Failed Tests:" >> $GITHUB_STEP_SUMMARY
                    echo "$FAILED_TEST_NAMES" | while read -r test_name; do
                      echo "  - $test_name" >> $GITHUB_STEP_SUMMARY
                    done
                  fi
                  echo "âŒ Some tests failed in $TEST_NAME." >> $GITHUB_STEP_SUMMARY
                else
                  echo "âœ… All tests passed in $TEST_NAME." >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
            
            FAILED_TESTS=$((TOTAL_TESTS - PASSED_TESTS))
            
            echo "#### Summary" >> $GITHUB_STEP_SUMMARY
            echo "- Total Vader Tests: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Total Passed: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Total Failed: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED_TESTS" -gt 0 ]; then
              echo "âŒ Some Vader tests failed." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… All Vader tests passed." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ðŸ§ª Vader Tests" >> $GITHUB_STEP_SUMMARY
            echo "âŒ No Vader test results found." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add overall summary
          echo "## ðŸ“ˆ Overall Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Jest Tests: $TOTAL_TESTS total, $PASSED_TESTS passed, $FAILED_TESTS failed" >> $GITHUB_STEP_SUMMARY
          echo "- Vader Tests: $TOTAL_TESTS total, $PASSED_TESTS passed, $FAILED_TESTS failed" >> $GITHUB_STEP_SUMMARY
          echo "- Total Tests: $((TOTAL_TESTS + TOTAL_TESTS))" >> $GITHUB_STEP_SUMMARY
          echo "- Total Passed: $((PASSED_TESTS + PASSED_TESTS))" >> $GITHUB_STEP_SUMMARY
          echo "- Total Failed: $((FAILED_TESTS + FAILED_TESTS))" >> $GITHUB_STEP_SUMMARY
      
      # Temporarily disabled artifact upload due to GitHub Actions issues
      # - name: Upload test artifacts
      #   if: always()
      #   uses: actions/upload-artifact@v2
      #   with:
      #     name: test-artifacts
      #     path: |
      #       test-output.log
      #       .ci-artifacts/vader-reports/
      #     retention-days: 7
